<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reborn Writing Practice - 教师端</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        :root {
            --primary: #0F6B6B;
            --secondary: #2a8c8c;
            --accent: #1C7C7C;
            --export: #3498db;
            --light: #F8F8F8;
            --dark: #212529;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --success: #2ecc71;
            --warning: #e67e22;
            --error: #e74c3c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
        }
        
        .motto {
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 15px;
            color: #e0f7f7;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            letter-spacing: 1px;
        }
        
        .teacher-tools {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .import-btn, .export-btn, .student-portal-btn {
            background-color: var(--export);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .student-portal-btn {
            background-color: #9b59b6;
        }
        
        .student-portal-btn:hover {
            background-color: #8e44ad;
        }
        
        .import-btn:hover, .export-btn:hover, .student-portal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }
        
        .import-btn:active, .export-btn:active, .student-portal-btn:active {
            transform: translateY(-1px);
        }
        
        .import-input {
            display: none;
        }
        
        .export-loading {
            display: none;
            color: white;
            font-size: 0.9rem;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .practice-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent);
            color: var(--primary);
        }
        
        .section-title i {
            margin-right: 15px;
            font-size: 1.8rem;
        }
        
        .section-import-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .section-import-btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .tip-box {
            background-color: #fdedec;
            border-left: 5px solid var(--accent);
            padding: 18px;
            margin: 25px 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        /* 句型检查样式 */
        .exercise-container {
            margin-bottom: 30px;
        }
        
        .exercise-item {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
            border-left: 5px solid var(--primary);
            position: relative;
        }
        
        .exercise-id {
            position: absolute;
            top: 15px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .exercise-chinese {
            font-size: 1.3rem;
            margin-bottom: 25px;
            color: #333;
            font-weight: 600;
            line-height: 1.8;
        }
        
        /* 文本框样式 */
        .exercise-input {
            width: 100%;
            min-height: 60px;
            padding: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background-color: white;
            resize: vertical;
            overflow-y: auto;
            line-height: 1.5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .exercise-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(15, 107, 107, 0.1);
        }
        
        .exercise-input.correct {
            border-color: var(--success);
            background-color: rgba(46, 204, 113, 0.05);
        }
        
        .exercise-input.incorrect {
            border-color: var(--error);
            background-color: rgba(231, 76, 60, 0.05);
        }
        
        .exercise-input.auto-height {
            min-height: 60px;
            max-height: 300px;
        }
        
        .exercise-feedback {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .exercise-feedback.correct {
            background-color: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--success);
            display: block;
        }
        
        .exercise-feedback.incorrect {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--error);
            display: block;
        }
        
        .feedback-answer {
            font-weight: 600;
            color: var(--primary);
            margin-top: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 40px 0;
            padding: 25px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 2px solid var(--primary);
        }
        
        .timer {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }
        
        .timer-label {
            font-size: 1.2rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        .timer-warning {
            color: var(--error);
            font-weight: 600;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 40px 0;
        }
        
        .control-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            min-width: 180px;
            justify-content: center;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .control-btn.submit {
            background-color: var(--success);
        }
        
        .control-btn.restart {
            background-color: var(--warning);
        }
        
        .control-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .attempt-counter {
            text-align: center;
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 600;
            margin-top: 25px;
            padding: 15px;
            background-color: rgba(15, 107, 107, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(15, 107, 107, 0.1);
        }
        
        .attempt-warning {
            color: var(--error);
            font-weight: bold;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .results-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 40px;
            box-shadow: var(--box-shadow);
            display: none;
        }
        
        .results-container.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .results-title {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }
        
        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border-top: 5px solid var(--primary);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: var(--dark);
        }
        
        .expression-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .expression-card {
            display: flex;
            flex-direction: column;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
            border-left: 5px solid var(--primary);
        }
        
        .expression-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .expression-zh {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .expression-en {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary);
            color: white;
            padding: 18px 28px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .student-link-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 30px;
            box-shadow: var(--box-shadow);
            border: 2px solid var(--accent);
            display: none;
        }
        
        .student-link-container.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .link-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        
        .student-link {
            font-size: 1.1rem;
            color: var(--primary);
            word-break: break-all;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            margin-top: 10px;
            display: block;
        }
        
        .copy-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .copy-btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .motto {
                font-size: 1.2rem;
            }
            
            .teacher-tools {
                flex-direction: column;
                align-items: center;
            }
            
            .exercise-item {
                padding: 20px;
            }
            
            .exercise-input {
                font-size: 1rem;
                padding: 15px;
                min-height: 55px;
            }
            
            .timer {
                font-size: 2rem;
            }
            
            .control-btn {
                padding: 15px 25px;
                min-width: 150px;
                font-size: 1rem;
            }
            
            .toast {
                left: 20px;
                right: 20px;
                bottom: 20px;
                max-width: none;
            }
            
            .section-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .section-import-btn {
                align-self: flex-start;
            }
        }
        
        /* 针对超长句子的特殊样式 */
        .exercise-input.long-sentence {
            font-size: 1.05rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Reborn Writing Practice - 教师端</h1>
        <p class="subtitle">汉译英句型练习系统</p>
        <p class="motto">教师管理界面 - 准备学生练习材料</p>
        <div class="teacher-tools">
            <button class="import-btn" id="importBtn">
                <i class="fas fa-file-import"></i>
                <span>导入练习句型</span>
            </button>
            <button class="export-btn" id="exportBtn">
                <i class="fas fa-file-word"></i>
                <span>导出学习材料</span>
            </button>
            <button class="student-portal-btn" id="studentPortalBtn">
                <i class="fas fa-user-graduate"></i>
                <span>生成学生练习页面</span>
            </button>
            <div class="export-loading" id="exportLoading">
                <i class="fas fa-spinner fa-spin"></i>
                正在生成文档...
            </div>
            <input type="file" id="importInput" class="import-input" accept=".txt,.pdf,.xlsx,.xls,.docx,.doc">
        </div>
    </header>
    
    <!-- 学生练习链接生成器 -->
    <div class="student-link-container" id="studentLinkContainer">
        <div class="section-title">
            <div style="display: flex; align-items: center;">
                <i class="fas fa-link"></i>
                <h2>学生练习链接</h2>
            </div>
        </div>
        
        <div class="tip-box">
            <p><strong>使用说明：</strong> 将此链接分享给学生，学生可以直接开始练习当前页面选定的句型。</p>
            <p>学生界面将包含与教师端完全相同的练习题目、计时器和批改功能，但不包含导入功能。</p>
        </div>
        
        <div class="link-box">
            <p><strong>学生练习链接：</strong></p>
            <div class="student-link" id="studentLinkText">正在生成链接...</div>
            <button class="copy-btn" id="copyLinkBtn">
                <i class="fas fa-copy"></i>
                复制链接
            </button>
        </div>
        
        <div class="tip-box">
            <p><strong>提示：</strong> 学生练习数据基于当前页面显示的题目。如需更改学生练习内容，请先导入或修改当前页面的句型，然后重新生成链接。</p>
        </div>
    </div>
    
    <!-- 句型检查部分 -->
    <div class="practice-section" id="sentence">
        <div class="section-title">
            <div style="display: flex; align-items: center;">
                <i class="fas fa-edit"></i>
                <h2>句型检查练习</h2>
            </div>
            <button class="section-import-btn" id="sentenceImportBtn">
                <i class="fas fa-file-import"></i>
                导入练习句型
            </button>
            <input type="file" id="sentenceImportInput" class="import-input" accept=".txt,.pdf,.xlsx,.xls,.docx,.doc">
        </div>
        
        <div class="tip-box">
            <p><strong>使用说明：</strong> 根据中文提示输入对应的英文句子。每个句型最多练习5次。</p>
            <p><strong>导入格式：</strong> 一行一个句子，格式为"中文|英文|语法类型|话题"。例：保持均衡饮食对于预防慢性疾病至关重要。|Maintaining a balanced diet is crucial for preventing chronic diseases.|简单句|健康</p>
            <p><strong>提示：</strong> 文本框会自动调整高度以适应长句子，您也可以手动拖动右下角调整大小。</p>
        </div>
        
        <div class="timer-container">
            <div class="timer-label">练习用时:</div>
            <div class="timer" id="timer">00:00:00</div>
            <div class="timer-warning" id="timerWarning" style="display: none;">时间已到，不能再回答了哦</div>
        </div>
        
        <div class="exercise-container" id="exerciseContainer">
            <!-- 动态生成练习题目 -->
        </div>
        
        <div class="controls-container">
            <button class="control-btn submit" id="submitBtn">
                <i class="fas fa-paper-plane"></i>提交答案
            </button>
            <button class="control-btn restart" id="restartBtn">
                <i class="fas fa-redo"></i>重新开始
            </button>
        </div>
        
        <div class="attempt-counter" id="attemptCounter">
            第1次练习
        </div>
        
        <div class="results-container" id="resultsContainer">
            <h3 class="results-title">练习结果</h3>
            <div class="results-stats">
                <div class="stat-item">
                    <div class="stat-value" id="scoreValue">0%</div>
                    <div class="stat-label">正确率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="timeValue">00:00</div>
                    <div class="stat-label">用时</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correctValue">0</div>
                    <div class="stat-label">正确题数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalValue">0</div>
                    <div class="stat-label">总题数</div>
                </div>
            </div>
            
            <div class="expression-grid" id="expressionGrid">
                <!-- 动态生成表达网格 -->
            </div>
        </div>
    </div>
    
    <footer>
        <p>Reborn Writing Practice - 教师端 | 汉译英句型练习系统</p>
        <p>教师管理界面 | 天天进步，每日新生</p>
    </footer>
    
    <!-- 提示信息 -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">操作成功！</span>
    </div>
    
    <script>
        // 全局变量
        let sentences = [];
        let currentExercises = [];
        let userAnswers = {};
        let exerciseAttempts = 0;
        let maxAttempts = 5;
        let timerInterval = null;
        let secondsElapsed = 0;
        let maxTime = 3600; // 1小时
        let timeLimitReached = false;
        
        // 语法类型和话题
        const grammarTypes = ['简单句', '并列句', '后置定语', '状语从句', '定语从句'];
        const topics = ['教育', '职场', '社会现象', '科技', '环境', '健康', '经济', '文化'];
        
        // 初始化默认句子数据
        const defaultSentences = [
            { 
                id: 1, 
                chinese: "保持均衡饮食对于预防慢性疾病至关重要。", 
                english: "Maintaining a balanced diet is crucial for preventing chronic diseases.", 
                grammar: "简单句", 
                topic: "健康" 
            },
            { 
                id: 2, 
                chinese: "虽然肥胖是一个严重的健康问题，但通过合理的饮食和运动是可以控制的。", 
                english: "Although obesity is a serious health issue, it can be controlled through proper diet and exercise.", 
                grammar: "让步状语从句", 
                topic: "健康" 
            },
            { 
                id: 3, 
                chinese: "政府应该采取措施减少不健康食品的广告，特别是针对儿童的广告。", 
                english: "The government should take measures to reduce advertising of unhealthy foods, especially those targeting children.", 
                grammar: "后置定语", 
                topic: "健康政策" 
            },
            { 
                id: 4, 
                chinese: "糖尿病不仅影响患者的身体健康，还给医疗系统带来巨大的经济负担。", 
                english: "Diabetes not only affects patients' physical health but also imposes a significant economic burden on the healthcare system.", 
                grammar: "并列句", 
                topic: "医疗经济" 
            },
            { 
                id: 5, 
                chinese: "心脏病是现代社会中导致死亡的主要原因之一，这与现代人的生活方式密切相关。", 
                english: "Heart disease is one of the leading causes of death in modern society, which is closely related to contemporary lifestyles.", 
                grammar: "定语从句", 
                topic: "公共健康" 
            }
        ];
        
        // 获取随机元素
        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // 初始化练习题
        function initializeExercises() {
            // 如果句子数据为空，使用默认数据
            if (sentences.length === 0) {
                sentences = [...defaultSentences];
            }
            
            // 重置状态
            currentExercises = [];
            userAnswers = {};
            exerciseAttempts = 0;
            secondsElapsed = 0;
            timeLimitReached = false;
            
            // 清空容器
            const exerciseContainer = document.getElementById('exerciseContainer');
            exerciseContainer.innerHTML = '';
            
            // 隐藏结果
            document.getElementById('resultsContainer').classList.remove('show');
            
            // 如果没有句子，显示提示
            if (sentences.length === 0) {
                exerciseContainer.innerHTML = `
                    <div class="tip-box">
                        <p><strong>提示：</strong> 请先导入句型练习文档！</p>
                        <p>格式：中文|英文|语法类型|话题（每行一个句子）</p>
                        <p>例：保持均衡饮食对于预防慢性疾病至关重要。|Maintaining a balanced diet is crucial for preventing chronic diseases.|简单句|健康</p>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('restartBtn').disabled = true;
                return;
            }
            
            // 随机选择5个句子（或全部，如果少于5个）
            const shuffledSentences = [...sentences].sort(() => 0.5 - Math.random());
            const selectedSentences = shuffledSentences.slice(0, Math.min(5, sentences.length));
            
            // 生成练习题目
            selectedSentences.forEach((sentence, index) => {
                currentExercises.push(sentence);
                
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                exerciseItem.innerHTML = `
                    <div class="exercise-id">${index + 1}</div>
                    <div class="exercise-chinese">${sentence.chinese}</div>
                    <div class="grammar-tags" style="margin-bottom: 15px;">
                        <span style="background-color: #e3f2fd; padding: 5px 10px; border-radius: 15px; margin-right: 10px; font-size: 0.9rem;">${sentence.grammar || '未指定'}</span>
                        <span style="background-color: #f3e5f5; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">${sentence.topic || '未指定'}</span>
                    </div>
                    <textarea class="exercise-input auto-height" id="answer${sentence.id}" 
                           placeholder="请输入对应的英文表达..." data-id="${sentence.id}" 
                           rows="1" oninput="autoResizeTextarea(this)"></textarea>
                    <div class="exercise-feedback" id="feedback${sentence.id}"></div>
                `;
                
                exerciseContainer.appendChild(exerciseItem);
                
                // 添加输入监听
                const inputElement = document.getElementById(`answer${sentence.id}`);
                inputElement.addEventListener('input', function() {
                    const id = this.getAttribute('data-id');
                    userAnswers[id] = this.value.trim();
                });
            });
            
            // 更新尝试计数器
            updateAttemptCounter();
            
            // 启动计时器
            startTimer();
            
            // 启用提交按钮
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('restartBtn').disabled = false;
        }
        
        // 自动调整文本框高度的函数
        function autoResizeTextarea(textarea) {
            // 重置高度
            textarea.style.height = 'auto';
            
            // 根据内容计算高度
            const contentHeight = textarea.scrollHeight;
            const maxHeight = 300; // 最大高度限制
            
            // 设置新高度，但不超过最大高度
            const newHeight = Math.min(contentHeight, maxHeight);
            textarea.style.height = newHeight + 'px';
            
            // 如果内容特别长，添加特殊样式
            if (contentHeight > 150) {
                textarea.classList.add('long-sentence');
            } else {
                textarea.classList.remove('long-sentence');
            }
        }
        
        // 更新尝试计数器
        function updateAttemptCounter() {
            const attemptCounter = document.getElementById('attemptCounter');
            
            if (exerciseAttempts >= maxAttempts) {
                attemptCounter.innerHTML = '<span class="attempt-warning">你重复的次数太多啦，需要再次复习哦！</span>';
                document.getElementById('restartBtn').disabled = true;
            } else {
                attemptCounter.textContent = `第${exerciseAttempts + 1}次练习`;
            }
        }
        
        // 开始计时器
        function startTimer() {
            // 清除已有计时器
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // 重置时间
            secondsElapsed = 0;
            updateTimerDisplay();
            
            // 隐藏时间警告
            document.getElementById('timerWarning').style.display = 'none';
            
            // 启动新计时器
            timerInterval = setInterval(function() {
                secondsElapsed++;
                updateTimerDisplay();
                
                // 检查时间限制
                if (secondsElapsed >= maxTime) {
                    timeLimitReached = true;
                    clearInterval(timerInterval);
                    document.getElementById('timerWarning').style.display = 'block';
                    submitExercises();
                } else if (secondsElapsed >= 1800) { // 30分钟警告
                    document.getElementById('timerWarning').style.display = 'block';
                    document.getElementById('timerWarning').textContent = "时间已到，不能再回答了哦";
                }
            }, 1000);
        }
        
        // 更新计时器显示
        function updateTimerDisplay() {
            const hours = Math.floor(secondsElapsed / 3600);
            const minutes = Math.floor((secondsElapsed % 3600) / 60);
            const seconds = secondsElapsed % 60;
            
            const timerElement = document.getElementById('timer');
            timerElement.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 验证所有答案是否符合要求
        function validateAnswers() {
            if (currentExercises.length === 0) return false;
            
            for (const exercise of currentExercises) {
                const answer = userAnswers[exercise.id] || '';
                
                // 检查是否已填写
                if (!answer.trim()) {
                    showToast('请尽全力作答哦，认真写完才可以提交呢~', 3000);
                    return false;
                }
                
                // 检查字符数是否达到20个
                if (answer.length < 20) {
                    showToast('请尽全力作答哦，认真写完才可以提交呢~', 3000);
                    return false;
                }
            }
            
            return true;
        }
        
        // 提交练习
        document.getElementById('submitBtn').addEventListener('click', submitExercises);
        
        function submitExercises() {
            // 验证答案
            if (!validateAnswers()) {
                return;
            }
            
            // 停止计时器
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // 禁用提交按钮
            document.getElementById('submitBtn').disabled = true;
            
            let correctCount = 0;
            const totalExercises = currentExercises.length;
            
            // 检查每个答案
            currentExercises.forEach(exercise => {
                const userAnswer = userAnswers[exercise.id] || '';
                const correctAnswer = exercise.english.toLowerCase().trim();
                const isCorrect = userAnswer.toLowerCase().trim() === correctAnswer;
                
                const answerInput = document.getElementById(`answer${exercise.id}`);
                const feedbackElement = document.getElementById(`feedback${exercise.id}`);
                
                if (isCorrect) {
                    correctCount++;
                    answerInput.classList.add('correct');
                    answerInput.classList.remove('incorrect');
                    feedbackElement.className = 'exercise-feedback correct';
                    feedbackElement.innerHTML = `<i class="fas fa-check-circle"></i> 正确！`;
                } else {
                    answerInput.classList.add('incorrect');
                    answerInput.classList.remove('correct');
                    feedbackElement.className = 'exercise-feedback incorrect';
                    feedbackElement.innerHTML = `
                        <i class="fas fa-times-circle"></i> 不正确。
                        <div class="feedback-answer">正确答案: ${exercise.english}</div>
                    `;
                }
            });
            
            // 计算分数
            const score = Math.round((correctCount / totalExercises) * 100);
            
            // 更新结果
            document.getElementById('scoreValue').textContent = `${score}%`;
            document.getElementById('timeValue').textContent = formatTime(secondsElapsed);
            document.getElementById('correctValue').textContent = correctCount;
            document.getElementById('totalValue').textContent = totalExercises;
            
            // 显示结果
            document.getElementById('resultsContainer').classList.add('show');
            
            // 生成表达网格
            generateExpressionGrid();
            
            // 增加尝试次数
            exerciseAttempts++;
            updateAttemptCounter();
        }
        
        // 格式化时间
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // 重新开始练习
        document.getElementById('restartBtn').addEventListener('click', function() {
            if (exerciseAttempts >= maxAttempts) {
                showToast('已达到最大练习次数，请先复习再尝试', 3000);
                return;
            }
            
            initializeExercises();
        });
        
        // 生成表达网格
        function generateExpressionGrid() {
            const expressionGrid = document.getElementById('expressionGrid');
            expressionGrid.innerHTML = '';
            
            // 从当前练习中提取表达
            const expressions = currentExercises.map(exercise => {
                return {
                    chinese: exercise.chinese.substring(0, 30) + (exercise.chinese.length > 30 ? '...' : ''),
                    english: exercise.english.substring(0, 40) + (exercise.english.length > 40 ? '...' : '')
                };
            });
            
            // 添加表达卡片
            expressions.forEach(expr => {
                if (!expr.english) return;
                
                const expressionCard = document.createElement('div');
                expressionCard.className = 'expression-card';
                expressionCard.innerHTML = `
                    <div class="expression-zh">${expr.chinese}</div>
                    <div class="expression-en">${expr.english}</div>
                `;
                
                expressionGrid.appendChild(expressionCard);
            });
        }
        
        // 句型导入功能
        document.getElementById('importBtn').addEventListener('click', function() {
            document.getElementById('importInput').click();
        });
        
        document.getElementById('sentenceImportBtn').addEventListener('click', function() {
            document.getElementById('importInput').click();
        });
        
        document.getElementById('importInput').addEventListener('change', function(event) {
            handleSentenceImport(event);
        });
        
        // 处理句型导入
        async function handleSentenceImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showToast('正在导入练习句型...', 3000);
                
                const content = await readTextFile(file);
                const parsedSentences = parseSentencesFromContent(content);
                
                if (parsedSentences.length > 0) {
                    sentences = parsedSentences;
                    initializeExercises();
                    showToast(`成功导入${sentences.length}个练习句型`, 3000);
                    
                    // 重新生成学生链接
                    generateStudentLink();
                } else {
                    showToast('导入失败：未能解析到有效句子', 3000);
                }
                
                // 重置文件输入
                event.target.value = '';
                
            } catch (error) {
                console.error('导入句型时出错:', error);
                showToast(`导入失败: ${error.message}`, 5000);
            }
        }
        
        // 读取文本文件
        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('读取文件失败'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // 从内容解析句子数据
        function parseSentencesFromContent(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const sentences = [];
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                // 尝试多种格式
                let chinese = '', english = '', grammar = '', topic = '';
                
                // 格式1: 中文|英文|语法|话题 (完整格式)
                if (line.includes('|')) {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2) {
                        chinese = parts[0];
                        english = parts[1];
                        grammar = parts[2] || getRandomElement(grammarTypes);
                        topic = parts[3] || getRandomElement(topics);
                    }
                }
                // 格式2: 中文 英文 (简单格式)
                else if (line.match(/[\u4e00-\u9fff]/) && line.match(/[a-zA-Z]/)) {
                    // 找到第一个英文字母的位置
                    const englishStart = line.search(/[a-zA-Z]/);
                    if (englishStart > 0) {
                        chinese = line.substring(0, englishStart).trim();
                        english = line.substring(englishStart).trim();
                        grammar = getRandomElement(grammarTypes);
                        topic = getRandomElement(topics);
                    }
                }
                // 格式3: 只有中文
                else if (line.match(/^[\u4e00-\u9fff\s]+$/)) {
                    chinese = line;
                    english = `翻译: ${line}`;
                    grammar = getRandomElement(grammarTypes);
                    topic = getRandomElement(topics);
                }
                // 格式4: 只有英文
                else if (line.match(/^[a-zA-Z\s\.]+$/)) {
                    english = line;
                    chinese = `翻译: ${line}`;
                    grammar = getRandomElement(grammarTypes);
                    topic = getRandomElement(topics);
                }
                
                if (chinese && english) {
                    sentences.push({
                        id: sentences.length + 1,
                        chinese: chinese,
                        english: english,
                        grammar: grammar,
                        topic: topic
                    });
                }
            });
            
            return sentences;
        }
        
        // 生成学生练习链接
        function generateStudentLink() {
            const studentLinkContainer = document.getElementById('studentLinkContainer');
            const studentLinkText = document.getElementById('studentLinkText');
            
            // 如果当前没有练习题目，显示提示
            if (currentExercises.length === 0) {
                showToast('请先导入或创建练习题目', 3000);
                return;
            }
            
            // 准备学生练习数据
            const studentExercises = currentExercises.map(exercise => ({
                chinese: exercise.chinese,
                english: exercise.english,
                grammar: exercise.grammar,
                topic: exercise.topic
            }));
            
            // 创建学生页面URL
            const baseUrl = window.location.origin + window.location.pathname;
            const studentData = encodeURIComponent(JSON.stringify(studentExercises));
            const studentUrl = `${baseUrl}?student=1&data=${studentData}`;
            
            // 显示链接
            studentLinkText.textContent = studentUrl;
            studentLinkContainer.classList.add('show');
            
            // 滚动到链接部分
            studentLinkContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 生成学生练习页面
        function generateStudentPage() {
            // 获取当前页面URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const isStudentPage = urlParams.get('student') === '1';
            const studentData = urlParams.get('data');
            
            if (isStudentPage && studentData) {
                try {
                    // 解析学生练习数据
                    const exercises = JSON.parse(decodeURIComponent(studentData));
                    
                    // 更新页面标题
                    document.title = "Reborn Writing Practice - 学生练习";
                    document.querySelector('h1').textContent = "Reborn Writing Practice - 学生练习";
                    document.querySelector('.subtitle').textContent = "汉译英句型练习";
                    document.querySelector('.motto').textContent = "学生练习界面 - 请根据中文提示写出英文句子";
                    
                    // 移除教师工具
                    document.querySelector('.teacher-tools').style.display = 'none';
                    
                    // 移除导入按钮
                    document.getElementById('sentenceImportBtn').style.display = 'none';
                    
                    // 更新句子数据
                    sentences = exercises.map((exercise, index) => ({
                        id: index + 1,
                        chinese: exercise.chinese,
                        english: exercise.english,
                        grammar: exercise.grammar,
                        topic: exercise.topic
                    }));
                    
                    // 初始化练习
                    initializeExercises();
                    
                } catch (error) {
                    console.error('解析学生数据时出错:', error);
                    showToast('加载学生练习失败，请联系教师', 5000);
                }
            }
        }
        
        // 复制链接功能
        document.getElementById('copyLinkBtn').addEventListener('click', function() {
            const studentLinkText = document.getElementById('studentLinkText');
            const link = studentLinkText.textContent;
            
            navigator.clipboard.writeText(link).then(() => {
                showToast('链接已复制到剪贴板', 2000);
            }).catch(err => {
                console.error('复制失败: ', err);
                showToast('复制失败，请手动复制', 3000);
            });
        });
        
        // 生成学生页面按钮
        document.getElementById('studentPortalBtn').addEventListener('click', generateStudentLink);
        
        // 导出功能
        document.getElementById('exportBtn').addEventListener('click', async function() {
            const exportBtn = this;
            const exportLoading = document.getElementById('exportLoading');
            
            // 显示加载状态
            exportBtn.style.display = 'none';
            exportLoading.style.display = 'flex';
            
            try {
                // 生成文档
                const doc = await generateWordDocument();
                
                // 保存文档
                const buffer = await docx.Packer.toBlob(doc);
                const fileName = `Reborn写作练习材料_${new Date().toISOString().slice(0, 10)}.docx`;
                
                saveAs(buffer, fileName);
                
                // 显示成功消息
                showToast('文档已成功生成并开始下载！', 3000);
                
            } catch (error) {
                console.error('生成文档时出错:', error);
                showToast('生成文档时出错，请重试', 5000);
            } finally {
                // 恢复按钮状态
                exportBtn.style.display = 'flex';
                exportLoading.style.display = 'none';
            }
        });
        
        // 生成Word文档
        async function generateWordDocument() {
            const dataToExport = sentences;
            const title = "句型练习材料";
            
            // 创建文档
            const doc = new docx.Document({
                sections: [{
                    properties: {},
                    children: [
                        // 标题
                        new docx.Paragraph({
                            text: `Reborn写作练习 - ${title}`,
                            heading: docx.HeadingLevel.TITLE,
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 400 }
                        }),
                        
                        // 副标题
                        new docx.Paragraph({
                            text: `生成时间：${new Date().toLocaleDateString('zh-CN')}`,
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 600 }
                        }),
                        
                        // 内容
                        ...generateContentForExport(dataToExport),
                        
                        // 页脚
                        new docx.Paragraph({
                            text: "--- 文档结束 ---",
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { before: 800 },
                            border: { top: { style: docx.BorderStyle.SINGLE, size: 2, color: "0F6B6B" } }
                        }),
                        
                        new docx.Paragraph({
                            text: "Reborn Writing Practice | 天天进步，每日新生",
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 200 }
                        })
                    ]
                }]
            });
            
            return doc;
        }
        
        // 生成导出内容
        function generateContentForExport(data) {
            const paragraphs = [];
            
            // 句型内容
            paragraphs.push(
                new docx.Paragraph({
                    text: "句型练习材料",
                    heading: docx.HeadingLevel.HEADING_1,
                    spacing: { before: 400, after: 300 }
                })
            );
            
            data.forEach((item, index) => {
                paragraphs.push(
                    new docx.Paragraph({
                        text: `${index + 1}. [${item.grammar}] [${item.topic}]`,
                        heading: docx.HeadingLevel.HEADING_3,
                        spacing: { before: 200, after: 50 }
                    })
                );
                
                paragraphs.push(
                    new docx.Paragraph({
                        text: `中文: ${item.chinese}`,
                        spacing: { after: 30 }
                    })
                );
                
                paragraphs.push(
                    new docx.Paragraph({
                        text: `英文: ${item.english}`,
                        spacing: { after: 100 },
                        border: { bottom: { style: docx.BorderStyle.SINGLE, size: 1, color: "e0e0e0" } }
                    })
                );
            });
            
            return paragraphs;
        }
        
        // 显示提示信息
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 初始化页面
        function initializePage() {
            // 检查是否是学生页面
            const urlParams = new URLSearchParams(window.location.search);
            const isStudentPage = urlParams.get('student') === '1';
            
            if (isStudentPage) {
                // 如果是学生页面，生成学生练习页面
                generateStudentPage();
            } else {
                // 否则，初始化教师页面
                sentences = [...defaultSentences];
                initializeExercises();
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>